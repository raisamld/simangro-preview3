<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Peta Aksi Mangrove - SIMANGRO</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#059669">
  <link rel="icon" type="image/png" sizes="32x32" href="img/logo-KKP.png"> <link rel="icon" type="image/png" sizes="16x16" href="img/logo-KKP.png"> <link rel="apple-touch-icon" sizes="180x180" href="img/logo-KKP.png">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.shapefile/1.0.1/leaflet.shpfile.js"></script>
  <style>
    :root {
      --primary: #059669;
      --primary-light: #10b981;
      --primary-dark: #047857;
      --secondary: #0ea5e9;
      --accent: #16a34a;
      --accent-light: #22c55e;
      --accent-dark: #15803d;
      --dark: #0f172a;
      --muted: #64748b;
      --white: #ffffff;
      --border: #d1fae5;
      
      --shadow: 0 4px 16px rgba(22, 163, 74, 0.1);
      --shadow-hover: 0 8px 32px rgba(22, 163, 74, 0.15);
      --shadow-intense: 0 20px 40px rgba(22, 163, 74, 0.2);
      
      --gradient-primary: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
      --gradient-bg: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 50%, #d1fae5 100%);
      --gradient-text: linear-gradient(135deg, var(--primary), var(--primary-light), var(--secondary));
      
      --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      
      --max-width: 1000px;
    }

    * { box-sizing: border-box; }

    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Plus Jakarta Sans', sans-serif;
      background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 50%, #d1fae5 100%);
      background-attachment: fixed;
      color: var(--dark);
      font-size: 16px;
      line-height: 1.6;
      /* Prevent accidental horizontal scrolling from off-canvas controls or wide elements */
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 80%, rgba(22, 163, 74, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(34, 197, 94, 0.06) 0%, transparent 50%);
      animation: float 25s ease-in-out infinite;
      z-index: -1;
    }

    @keyframes float {
      0%, 100% { transform: scale(1) rotate(0deg); }
      33% { transform: scale(1.05) rotate(1deg); }
      66% { transform: scale(0.95) rotate(-1deg); }
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      box-shadow: var(--shadow-intense);
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 3px solid transparent;
      border-image: var(--gradient-primary) 1;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(22, 163, 74, 0.25);
      flex-shrink: 0;
    }

    .logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .sitename {
      font-weight: 800;
      font-size: 1.75rem;
      background: var(--gradient-text);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.02em;
    }

    /* ============ BURGER MENU ============ */
    .burger-menu {
      display: flex;
      cursor: pointer;
      background: rgba(15,23,42,0.04);
      border: none;
      padding: 8px;
      z-index: 1001;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 8px;
      transition: background-color var(--transition), transform var(--transition);
      box-shadow: 0 1px 0 rgba(0,0,0,0.03);
    }

    .burger-menu:hover {
      background: rgba(22, 163, 74, 0.1);
      transform: scale(1.05);
    }

    .burger-menu img {
      width: 24px;
      height: 24px;
      opacity: 1 !important;
      filter: none !important;
    }

    .burger-menu img.menu-icon { display: block; }

    @media (prefers-color-scheme: dark) {
      .burger-menu { background: rgba(255,255,255,0.04); }
    }

    /* ============ NAVIGATION ============ */
    .nav {
      position: fixed;
      top: 0;
      right: -100%;
      height: 100vh;
      width: 80%;
      max-width: 300px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      flex-direction: column;
      padding: 80px 24px 24px;
      transition: right var(--transition);
      box-shadow: var(--shadow);
      z-index: 1000;
      display: flex;
      gap: 8px;
    }

    .nav.active {
      right: 0;
    }

    .nav a {
      color: var(--muted);
      text-decoration: none;
      font-weight: 600;
      padding: 12px 20px;
      border-radius: 25px;
      transition: all var(--transition);
      font-size: 0.9rem;
      position: relative;
      overflow: hidden;
    }

    .nav a::before {
      content: '';
      position: absolute;
      inset: 0;
      background: var(--gradient-primary);
      opacity: 0;
      transition: opacity var(--transition);
      z-index: -1;
    }

    .nav a:hover {
      color: var(--white);
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    .nav a:hover::before {
      opacity: 1;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 24px;
    }

    .page-header {
      text-align: center;
      margin-bottom: 48px;
      padding: 40px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      box-shadow: 0 20px 40px rgba(22, 163, 74, 0.2);
      border: 1px solid rgba(255,255,255,0.3);
    }

    .page-header h1 {
      font-size: 2.4rem;
      font-weight: 800;
      background: var(--gradient-text);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 12px;
    }

    .page-header p {
      color: var(--muted);
      font-size: 1rem;
      margin: 0;
    }

    .map-wrapper {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px);
      padding: 24px;
      border-radius: 24px;
      box-shadow: 0 20px 40px rgba(22, 163, 74, 0.2);
      margin-bottom: 32px;
      position: relative;
      display: flex;
      gap: 20px;
      align-items: stretch;
    }

    .map-area {
      flex: 1;
      position: relative;
    }

    .top-controls {
      display:flex;
      gap:8px;
      align-items:center;
      justify-content: center;
      background: rgba(255,255,255,0.98);
      padding:12px;
      border-radius:10px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
      margin-bottom: 24px;
      font-family: 'Plus Jakarta Sans';
      flex-wrap: wrap;
      color: var(--dark);
    }

    .top-controls input[type="search"], .top-controls select {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid rgba(15,23,42,0.06);
      font-size: 13px;
      width: 200px;
      font-family: 'Plus Jakarta Sans';
    }

    .top-controls button {
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      background: var(--primary);
      color: white;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      font-family: 'Plus Jakarta Sans';
    }

    .results-list {
      list-style: none;
      margin: 8px 0 0 0;
      padding: 0;
      display: block;
    }
    .results-list li {
      padding: 8px 10px;
      border-bottom: 1px solid rgba(15,23,42,0.04);
      cursor: pointer;
      font-size: 14px;
    }
    .results-list li:hover { background: rgba(15,23,42,0.02); }

    .info-panel {
      width: 340px;
      min-width: 260px;
      max-width: 40%;
      background: rgba(255,255,255,0.98);
      border-radius: 12px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.08);
      padding: 16px;
      overflow-y: auto;
      height: 600px;
    }

    .info-panel h4 { margin: 0 0 8px 0; }

    @media (max-width: 920px) {
      .map-wrapper { flex-direction: column; }
      .info-panel { width: 100%; max-width: 100%; height: 280px; }
      .top-controls input[type="search"], .top-controls select { width: 120px; }
    }

    /* Compact Leaflet layer control to reduce footprint */
    .leaflet-control-layers {
      font-size: 12px !important;
      padding: 6px !important;
      max-width: 220px !important;
    }
    .leaflet-control-layers .leaflet-control-layers-list { max-height: 200px; overflow: auto; }
    .leaflet-control-layers label { padding: 4px 6px !important; font-size: 11px !important; display: flex; align-items: center; gap: 8px; }
    .leaflet-control-layers input[type="checkbox"], .leaflet-control-layers input[type="radio"] { width: 14px; height: 14px; transform: scale(0.9); margin-right: 6px; }

    #map {
      height: 600px;
      width: 100%;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }

    .legend {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 16px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      position: absolute;
      bottom: 44px;
      right: 44px;
      z-index: 1000;
    }

    .legend h4 {
      margin: 0 0 10px;
      color: var(--primary);
      font-weight: 700;
      font-size: 14px;
      padding-bottom: 6px;
      border-bottom: 2px solid var(--border);
    }

    .legend p {
      margin: 8px 0;
      color: var(--dark);
      font-size: 13px;
    }

    .chart-section {
      margin-top: 48px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px);
      padding: 40px;
      border-radius: 24px;
      box-shadow: 0 20px 40px rgba(22, 163, 74, 0.2);
    }

    .chart-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .chart-header h2 {
      font-size: 1.8rem;
      font-weight: 800;
      background: var(--gradient-text);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 12px;
    }

    .chart-header p {
      color: var(--muted);
      font-size: 1rem;
      margin: 0;
    }

    .chart-container {
      position: relative;
      height: 500px;
      margin-bottom: 32px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 32px;
    }

    .stat-card {
      background: linear-gradient(145deg, rgba(22,163,74,0.05), rgba(22,163,74,0.02));
      padding: 24px;
      border-radius: 16px;
      border: 1px solid rgba(22,163,74,0.1);
      text-align: center;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(22, 163, 74, 0.15);
    }

    .stat-number {
      font-size: 1.8rem;
      font-weight: 800;
      color: var(--primary);
      display: block;
      margin-bottom: 8px;
    }

    .stat-label {
      color: var(--muted);
      font-weight: 600;
      font-size: 0.85rem;
    }

    .legend-custom {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 12px;
      max-height: 400px;
      overflow-y: auto;
      padding: 20px;
      background: rgba(255,255,255,0.5);
      border-radius: 12px;
      margin-top: 24px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: rgba(255,255,255,0.8);
      border-radius: 8px;
      font-size: 0.85rem;
      transition: all 0.2s ease;
    }

    .legend-item:hover {
      background: rgba(255,255,255,1);
      transform: translateX(4px);
    }

    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 3px;
      flex-shrink: 0;
    }

    .legend-text {
      flex: 1;
      color: var(--dark);
      font-weight: 500;
    }

    .legend-value {
      color: var(--primary);
      font-weight: 700;
    }

    .site-footer {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(20px);
      border-top: 1px solid rgba(22,163,74,0.15);
      padding: 32px 24px;
      display: flex;
      gap: 20px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      text-align: center;
      position: relative;
    }

    .site-footer::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--gradient-primary);
    }

    .footer-logo {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(22, 163, 74, 0.25);
      flex-shrink: 0;
    }

    .footer-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .footer-info {
      font-size: 0.9rem;
    }

    .footer-org {
      font-weight: 700;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .footer-copyright {
      color: var(--muted);
      font-size: 0.85rem;
      margin-top: 4px;
    }

    @media (max-width: 768px) {
      html, body { font-size: 14px; }
      .header { padding: 12px 16px; }
      .sitename { font-size: 1.3rem; }
      .page-header h1 { font-size: 1.8rem; }
      #map { height: 450px; }
      .legend { bottom: 32px; right: 32px; }
      .chart-container { height: 400px; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 520px) {
      .sitename { display: none; }
      .page-header h1 { font-size: 1.5rem; }
      #map { height: 400px; }
      .stats-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="brand">
      <a href="../index.html" class="logo">
        <img src="img/logo-KKP.png" alt="Logo SIMANGRO" />
      </a>
      <div class="sitename">SIMANGRO</div>
    </div>

    <button class="burger-menu" aria-label="Toggle menu" aria-expanded="false">
      <img src="img/menu-dark.png" alt="Menu" class="menu-icon">
    </button>

    <nav class="nav" aria-label="Menu utama">
      <a href="../index.html">Beranda</a>
      <a href="../jenis/index.html">Jenis Mangrove</a>
      <a href="peta sebaran.html">Peta Aksi Mangrove</a>
      <a href="../quiz.html">Quiz</a>
    </nav>
  </header>

  <div class="container">
    <div class="page-header">
      <h1>Peta Aksi Mangrove</h1>
      <p>Jelajahi upaya pelestarian mangrove yang dilakukan oleh Kementerian Kelautan dan Perikanan, mulai dari kegiatan penanaman, pusat restorasi, hingga pengembangan berbagai produk turunan mangrove, sebagai langkah dalam menjaga keseimbangan alam dan kesejahteraan masyarakat pesisir.</p>
    </div>

    <div class="top-controls">
      <input id="searchBox" type="search" placeholder="Cari lokasi atau kelompok" aria-label="Cari lokasi atau kelompok">
      <select id="filterProv"><option value="">Semua Provinsi</option></select>
      <select id="filterKab"><option value="">Semua Kabupaten</option></select>
      <select id="filterYear"><option value="">Semua Tahun</option></select>
      <button id="btnClear">Clear</button>
    </div>

    <div class="map-wrapper">
      <div class="map-area">
        <div id="map"></div>
      </div>
    </div>

    <div class="chart-section">
      <div class="chart-header">
        <h2>Luasan Penanaman Mangrove per Kabupaten & Kota</h2>
        <p>Data Program Rehabilitasi Mangrove Indonesia (Hektar)</p>
      </div>

      <div class="chart-container" style="height: 500px; position: relative; margin: 20px 0;">
        <canvas id="mangroveChart" style="width: 100%; height: 100%;"></canvas>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <span class="stat-number" id="totalLuas">0</span>
          <span class="stat-label">Total Luas (Ha)</span>
        </div>
        <div class="stat-card">
          <span class="stat-number" id="jumlahKabupaten">0</span>
          <span class="stat-label">Kabupaten/Kota</span>
        </div>
        <div class="stat-card">
          <span class="stat-number" id="rataRata">0</span>
          <span class="stat-label">Rata-rata (Ha)</span>
        </div>
        <div class="stat-card">
          <span class="stat-number" id="terbesar">0</span>
          <span class="stat-label">Terbesar (Ha)</span>
        </div>
      </div>

      <div class="legend-custom" id="customLegend"></div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="footer-logo">
      <img src="img/logo-KKP.png" alt="Logo KKP"/>
    </div>
    <div class="footer-info">
      <div class="footer-org">Kementerian Kelautan dan Perikanan</div>
      <div class="footer-copyright">Â© 2025 Kementerian Kelautan dan Perikanan Republik Indonesia</div>
    </div>
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // Add custom control styles
    const customControlCSS = document.createElement('style');
    customControlCSS.textContent = `
      .leaflet-control-layers {
        background: rgba(255, 255, 255, 0.95) !important;
        border-radius: 12px !important;
        box-shadow: 0 4px 16px rgba(22, 163, 74, 0.15) !important;
        padding: 8px !important;
        border: none !important;
        font-family: 'Plus Jakarta Sans', sans-serif !important;
        font-size: 12px !important;
      }
      .leaflet-control-layers-list {
        margin-bottom: 6px !important;
        max-height: 200px !important;
        overflow: auto !important;
      }
      .leaflet-control-layers-base label,
      .leaflet-control-layers-overlays label {
        padding: 4px 8px !important;
        border-radius: 6px !important;
        margin: 2px 0 !important;
        transition: all 0.15s ease !important;
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
      }
      .leaflet-control-layers-base label input[type="checkbox"],
      .leaflet-control-layers-base label input[type="radio"],
      .leaflet-control-layers-overlays label input[type="checkbox"],
      .leaflet-control-layers-overlays label input[type="radio"] {
        width: 14px !important;
        height: 14px !important;
        transform: scale(0.9) !important;
        margin-right: 8px !important;
      }
      .leaflet-control-layers-base label:hover,
      .leaflet-control-layers-overlays label:hover {
        background: rgba(22, 163, 74, 0.1) !important;
      }
      .leaflet-control-layers-separator {
        margin: 10px 0 !important;
        border-top: 2px solid rgba(22, 163, 74, 0.2) !important;
      }
    `;
    document.head.appendChild(customControlCSS);

    // Initialize the map
    const map = L.map('map', {
      center: [-2.5489, 118.0149],
      zoom: 5
    });

    // Add basemap layers
    const osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const ewi = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 19,
      attribution: '&copy; Esri'
    }).addTo(map);

    const baseMaps = {
      "OpenStreetMap": osm,
      "Esri World Imagery": ewi
    };

    const overlayMaps = {};

    function getLayerStyle(type) {
      const styles = {
        'mangrove': {
          color: '#ef4444',
          weight: 2,
          opacity: 1,
          fillOpacity: 0.5
        },
        'prpep': {
          color: '#0ea5e9',
          weight: 2,
          opacity: 1,
          fillOpacity: 0.5
        },
        'turunan': {
          color: '#8b5cf6',
          weight: 2,
          opacity: 1,
          fillOpacity: 0.5
        }
      };
      return styles[type] || styles.mangrove;
    }

    function createPopupContent(feature, title) {
      let popupContent = '<div style="font-family: \'Plus Jakarta Sans\', sans-serif; padding: 12px; min-width: 200px;">';
      popupContent += `<h3 style="margin: 0 0 8px 0; color: #16a34a; font-size: 14px; font-weight: 700;">${title}</h3>`;
      for (let prop in feature.properties) {
        if (feature.properties[prop] !== null && feature.properties[prop] !== '') {
          popupContent += `<p style="margin: 0 0 4px 0; font-size: 13px;"><strong>${prop}:</strong> ${feature.properties[prop]}</p>`;
        }
      }
      popupContent += '</div>';
      return popupContent;
    }

    function createMangrovePopup(feature) {
      const p = feature.properties || {};
      const pick = (...keys) => {
        for (const k of keys) {
          if (p[k] !== undefined && p[k] !== null && String(p[k]).trim() !== '') return p[k];
        }
        return '';
      };

      const desa = pick('Desa');
      const kecamatan = pick('Kecamatan');
      const kabupaten = pick('Kabupaten');
      const provinsi = pick('Provinsi');
      const luasRaw = pick('Luas');
      const kelompok = pick('Nama_Kel');
      const sumber = pick('Smbr_Anggr');

      let html = `<div style="font-family: 'Plus Jakarta Sans', sans-serif; padding: 8px; min-width:220px;">`;
      html += `<h3 style="margin:0 0 8px 0; color:#16a34a; font-size:15px; font-weight:700;">Data Penanaman Mangrove</h3>`;
      html += `<p style="margin:4px 0; font-size:13px;"><strong>Desa:</strong> ${desa || '-'}</p>`;
      html += `<p style="margin:4px 0; font-size:13px;"><strong>Kecamatan:</strong> ${kecamatan || '-'}</p>`;
      html += `<p style="margin:4px 0; font-size:13px;"><strong>Kabupaten/Kota:</strong> ${kabupaten || '-'}</p>`;
      html += `<p style="margin:4px 0; font-size:13px;"><strong>Provinsi:</strong> ${provinsi || '-'}</p>`;
      html += `<p style="margin:4px 0; font-size:13px;"><strong>Luas:</strong> ${luasRaw || ''} Ha</p>`;
      html += `<p style="margin:4px 0; font-size:13px;"><strong>Nama Kelompok:</strong> ${kelompok || '-'}</p>`;
      html += `<p style="margin:4px 0 0 0; font-size:13px;"><strong>Sumber Anggaran:</strong> ${sumber || '-'}</p>`;
      html += `</div>`;
      return html;
    }

    function createTurunanPopup(feature) {
      const p = feature.properties || {};
      const pick = (...keys) => {
        for (const k of keys) {
          if (p[k] !== undefined && p[k] !== null && String(p[k]).trim() !== '') return p[k];
        }
        return '';
      };

      const desa = pick('Desa');
      const kecamatan = pick('Kecamatan');
      const kabkota = pick('Kab_kota');
      const provinsi = pick('Provinsi');
      const tahun = pick('Tahun');
      const penerima = pick('Penerima');
      const bantuan = pick('Bantuan');
      const info = pick('Informasi');

      let html = `<div style="font-family: 'Plus Jakarta Sans', sans-serif; padding: 8px; min-width:220px;">`;
      html += `<h3 style="margin:0 0 8px 0; color:#16a34a; font-size:15px; font-weight:700;">Produk Turunan</h3>`;
      html += `<p style="margin:4px 0; font-size:13px;"><strong>Desa:</strong> ${desa || '-'}</p>`;
      html += `<p style="margin:4px 0; font-size:13px;"><strong>Kecamatan:</strong> ${kecamatan || '-'}</p>`;
      html += `<p style="margin:4px 0; font-size:13px;"><strong>Kabupaten/Kota:</strong> ${kabkota || '-'}</p>`;
      html += `<p style="margin:4px 0; font-size:13px;"><strong>Provinsi:</strong> ${provinsi || '-'}</p>`;
      html += `<p style="margin:4px 0; font-size:13px;"><strong>Tahun:</strong> ${tahun || '-'}</p>`;
      html += `<p style="margin:4px 0; font-size:13px;"><strong>Penerima:</strong> ${penerima || '-'}</p>`;
      html += `<p style="margin:4px 0 0 0; font-size:13px;"><strong>Bantuan:</strong> ${bantuan || '-'}</p>`;
      html += `<p style="margin:4px 0 0 0; font-size:13px;"><strong>Informasi:</strong> ${info || '-'}</p>`;
      html += `</div>`;
      return html;
    }

    function createPrpepPopup(feature) {
      const p = feature.properties || {};
      const pick = (...keys) => {
        for (const k of keys) {
          if (p[k] !== undefined && p[k] !== null && String(p[k]).trim() !== '') return p[k];
        }
        return '';
      };

      const provinsi = pick('Provinsi');
      const kabupaten = pick('Kabupaten');
      const kecamatan = pick('Kecamatan');
      const desa = pick('Desa');
      const penerima = pick('Penerima_Bantuan');
      const bantuan = pick('Bantuan');
      const tahun = pick('Tahun');

      let html = `<div style="font-family: 'Plus Jakarta Sans', sans-serif; padding: 8px; min-width:220px;">`;
      html += `<h3 style="margin:0 0 8px 0; color:#16a34a; font-size:15px; font-weight:700;">Lokasi PRPEP</h3>`;
      html += `<p style="margin:4px 0; font-size:13px;"><strong>Desa:</strong> ${desa || '-'}</p>`;
      html += `<p style="margin:4px 0; font-size:13px;"><strong>Kecamatan:</strong> ${kecamatan || '-'}</p>`;
      html += `<p style="margin:4px 0; font-size:13px;"><strong>Kabupaten/Kota:</strong> ${kabupaten || '-'}</p>`;
      html += `<p style="margin:4px 0; font-size:13px;"><strong>Provinsi:</strong> ${provinsi || '-'}</p>`;
      html += `<p style="margin:4px 0; font-size:13px;"><strong>Penerima Bantuan:</strong> ${penerima || '-'}</p>`;
      html += `<p style="margin:4px 0; font-size:13px;"><strong>Bantuan:</strong> ${bantuan || '-'}</p>`;
      html += `<p style="margin:4px 0 0 0; font-size:13px;"><strong>Tahun:</strong> ${tahun || '-'}</p>`;
      html += `</div>`;
      return html;
    }

    function addHoverEffects(layer, defaultStyle) {
      let isPopupOpenFromClick = false;

      layer.on({
        mouseover: function(e) {
          const target = e.target;
          if (typeof target.setStyle === 'function') {
            try {
              target.setStyle({
                fillOpacity: 0.8,
                weight: 3,
                color: (defaultStyle && defaultStyle.color) ? defaultStyle.color.replace('5e', '7e') : '#ffff00'
              });
            } catch (err) {}
          }
          if (!isPopupOpenFromClick) {
            target.openPopup();
          }
        },
        mouseout: function(e) {
          const target = e.target;
          if (typeof target.setStyle === 'function') {
            try { target.setStyle(defaultStyle); } catch (_) {}
          }
          if (!isPopupOpenFromClick) {
            target.closePopup();
          }
        },
        click: function(e) {
          const target = e.target;
          isPopupOpenFromClick = !isPopupOpenFromClick;

          if (isPopupOpenFromClick) {
            if (typeof target.getLatLng === 'function') {
              const pos = target.getLatLng();
              const point = map.project(pos);
              const mapSize = map.getSize();
              point.x = mapSize.x / 2;
              const offsetY = 80;
              point.y -= offsetY;
              const newCenter = map.unproject(point);
              map.setView(newCenter, Math.max(map.getZoom(), 12), {
                animate: true,
                duration: 0.5
              });
            }
            else if (typeof target.getBounds === 'function') {
              map.fitBounds(target.getBounds(), {
                padding: [50, 50],
                animate: true,
                duration: 0.5
              });
            }
            target.openPopup();
            try { const p = target.getPopup && target.getPopup(); if (p) p._openedByClick = true; } catch(_) {}
          } else {
            target.closePopup();
          }
        },
        popupclose: function() {
          isPopupOpenFromClick = false;
        }
      });
    }

    const layers = [
      {
        url: 'shp/Penanaman_Mangrove_KKP_2020_2024.geojson',
        name: 'Data Penanaman Mangrove',
        type: 'mangrove'
      },
      {
        url: 'shp/Lokasi_PRPEP_2015_2024.json',
        name: 'Lokasi Pusat Restorasi dan Pengembangan Ekosistem Pesisir (PRPEP)',
        type: 'prpep'
      },
      {
        url: 'shp/Produk_Turuna_2020_2024.json',
        name: 'Produk Turunan',
        type: 'turunan'
      }
    ];

    const layerPromises = layers.map(layerInfo => 
      fetch(layerInfo.url)
        .then(response => response.json())
        .then(data => {
          const style = getLayerStyle(layerInfo.type);
          const layer = L.geoJSON(data, {
            style: style,
            onEachFeature: (feature, layer) => {
              if (feature.properties) {
                if (layerInfo.type === 'mangrove') {
                  layer.bindPopup(createMangrovePopup(feature));
                } else if (layerInfo.type === 'turunan') {
                  layer.bindPopup(createTurunanPopup(feature));
                } else if (layerInfo.type === 'prpep') {
                  layer.bindPopup(createPrpepPopup(feature));
                } else {
                  layer.bindPopup(createPopupContent(feature, layerInfo.name));
                }
                addHoverEffects(layer, style);
              }
            }
          }).addTo(map);

          overlayMaps[layerInfo.name] = layer;
          if (!window.layerMeta) window.layerMeta = {};
          window.layerMeta[layerInfo.name] = layerInfo.type;

          try {
            layer.eachLayer(function(sub) {
              if (sub && sub.feature) {
                if (!window.featureIndex) window.featureIndex = [];
                const item = { layer: sub, parentLayer: layer, properties: sub.feature.properties || {}, type: layerInfo.type };
                window.featureIndex.push(item);

                try {
                  sub.on('click', function(e) {
                    if (typeof sub.getLatLng === 'function') {
                      const pos = sub.getLatLng();
                      const point = map.project(pos);
                      const panel = document.getElementById('infoPanel');
                      const panelWidth = (panel && panel.offsetWidth) ? panel.offsetWidth : 340;
                      const mapSize = map.getSize();
                      point.x = (mapSize.x - panelWidth) / 2;
                      const offsetY = 80;
                      point.y -= offsetY;
                      map.setView(map.unproject(point), Math.max(map.getZoom(), 12), { animate: true, duration: 0.4 });
                    } else if (typeof sub.getBounds === 'function') {
                      map.fitBounds(sub.getBounds(), { padding: [40,40], animate: true, duration: 0.4 });
                    }
                    if (sub.openPopup) {
                      sub.openPopup();
                      try { const p = sub.getPopup && sub.getPopup(); if (p) p._openedByClick = true; } catch(_) {}
                    }
                    showInfoForItem(item);
                  });
                } catch (e) {
                  console.warn('Failed to attach click handler to feature', e);
                }
              }
            });
          } catch (e) {
            console.warn('Indexing layer failed', e);
          }

          return layer;
        })
        .catch(error => {
          console.error(`Error loading ${layerInfo.name}:`, error);
          return null;
        })
    );

    Promise.all(layerPromises)
      .then(layers => {
        layers = layers.filter(layer => layer !== null);

        L.control.layers(baseMaps, overlayMaps).addTo(map);

        layers.forEach(layer => layer.addTo(map));

        if (layers.length > 0) {
          const group = L.featureGroup(layers);
          map.fitBounds(group.getBounds());
        }

        try {
          window.initialMapState = { center: map.getCenter(), zoom: map.getZoom() };
        } catch (e) { window.initialMapState = { center: [-2.5489,118.0149], zoom: 5 }; }

        try {
          const years = new Set();
          const kabs = new Set();
          const provs = new Set();
          (window.featureIndex || []).forEach(item => {
            const p = item.properties || {};
            const y = p.Tahun || p.tahun || p.tahun_tanam || p.Year || p.YEAR;
            const kab = p.Kabupaten || p.kabupaten || p.Kota || p.kota || p.Kab_kota || p['Kabupaten/Kota'];
            const prov = p.Provinsi || p.provinsi || p.Prov || p.PROVINSI;
            if (y) years.add(String(y));
            if (kab) kabs.add(String(kab));
            if (prov) provs.add(String(prov));
          });

          const yearSel = document.getElementById('filterYear');
          const kabSel = document.getElementById('filterKab');
          const provSel = document.getElementById('filterProv');
          
          if (yearSel) {
            Array.from(years).sort().forEach(y => {
              const opt = document.createElement('option'); opt.value = y; opt.textContent = y; yearSel.appendChild(opt);
            });
            yearSel.addEventListener('change', applyFilters);
          }
          if (kabSel) {
            Array.from(kabs).sort().forEach(k => {
              const opt = document.createElement('option'); opt.value = k; opt.textContent = k; kabSel.appendChild(opt);
            });
            kabSel.addEventListener('change', applyFilters);
          }
          if (provSel) {
            Array.from(provs).sort().forEach(p => {
              const opt = document.createElement('option'); opt.value = p; opt.textContent = p; provSel.appendChild(opt);
            });
            provSel.addEventListener('change', applyFilters);
          }

          const search = document.getElementById('searchBox');
          const clearBtn = document.getElementById('btnClear');
          if (search) {
            search.addEventListener('keypress', function(e) {
              if (e.key === 'Enter') doSearch();
            });
          }
          if (clearBtn) clearBtn.addEventListener('click', () => {
            document.getElementById('searchBox').value = '';
            document.getElementById('filterYear').value = '';
            document.getElementById('filterKab').value = '';
            applyFilters();
            clearInfoPanel();
            try {
              if (window.overlayMaps) {
                for (const name in overlayMaps) {
                  const lyr = overlayMaps[name];
                  if (lyr && !map.hasLayer(lyr)) map.addLayer(lyr);
                }
              }
                if (window.initialMapState) {
                  map.closePopup();
                  map.setView([-2.5489, 118.0149], 5);
                }
            } catch (e) { console.warn('reset failed', e); }
          });

          applyFilters();
        } catch (err) {
          console.warn('Error populating filters', err);
        }
      })
      .catch(error => {
        console.error('Error loading GeoJSON:', error);
      });

    function clearInfoPanel() {
      const panel = document.getElementById('infoContent');
      if (panel) panel.innerHTML = '<p>Pilih marker atau fitur untuk melihat detail di sini.</p>';
    }

    function showInfoForItem(item) {
      const panel = document.getElementById('infoContent');
      if (!panel) return;
      try {
        if (!item || !item.properties) { clearInfoPanel(); return; }
        if (item.type === 'mangrove') panel.innerHTML = createMangrovePopup({ properties: item.properties });
        else if (item.type === 'turunan') panel.innerHTML = createTurunanPopup({ properties: item.properties });
        else if (item.type === 'prpep') panel.innerHTML = createPrpepPopup({ properties: item.properties });
        else if (item.type === 'csv') panel.innerHTML = item.layer && item.layer.getPopup ? (item.layer.getPopup().getContent()) : ('<pre>' + JSON.stringify(item.properties, null, 2) + '</pre>');
        else panel.innerHTML = '<pre>' + JSON.stringify(item.properties, null, 2) + '</pre>';
      } catch (err) {
        panel.innerHTML = '<pre>' + JSON.stringify(item.properties, null, 2) + '</pre>';
      }
    }

    function applyFilters() {
      const year = (document.getElementById('filterYear') || {}).value || '';
      const kab = (document.getElementById('filterKab') || {}).value || '';
      const prov = (document.getElementById('filterProv') || {}).value || '';
      const idx = window.featureIndex || [];
      const matches = [];
      
      idx.forEach(item => {
        let visible = true;
        const p = item.properties || {};
        const y = String(p.Tahun || p.tahun || p.tahun_tanam || p.Year || p.YEAR || '') || '';
        const k = String(p.Kabupaten || p.kabupaten || p.Kota || p.kota || p.Kab_kota || p['Kabupaten/Kota'] || '') || '';
        const pr = String(p.Provinsi || p.provinsi || p.Prov || p.PROVINSI || '') || '';
        if (year && y !== year) visible = false;
        if (kab && k !== kab) visible = false;
        if (prov && pr !== prov) visible = false;
        try {
          if (visible) {
            matches.push(item);
            if (!map.hasLayer(item.layer)) map.addLayer(item.layer);
          } else {
            if (map.hasLayer(item.layer)) map.removeLayer(item.layer);
          }
        } catch (e) {}
      });

      if (matches.length && (prov || kab)) {
        const bounds = [];
        matches.forEach(m => {
          if (m.layer.getLatLng) {
            bounds.push(m.layer.getLatLng());
          } else if (m.layer.getBounds) {
            const b = m.layer.getBounds();
            bounds.push(b.getNorthWest());
            bounds.push(b.getSouthEast());
          }
        });
        
        if (bounds.length) {
          map.fitBounds(L.latLngBounds(bounds), {
            padding: [50, 50],
            maxZoom: 12,
            animate: true,
            duration: 0.5
          });
        }
      }
    }

    function doSearch() {
      const q = (document.getElementById('searchBox') || {}).value || '';
      if (!q) return applyFilters();
      const ql = q.trim().toLowerCase();
      const matches = [];
      (window.featureIndex || []).forEach(item => {
        const p = item.properties || {};
        const fields = ['Desa','desa','Kecamatan','kecamatan','Kabupaten','kabupaten','Provinsi','provinsi','Nama_Kel','kelompok','Penerima','penerima','Penerima_Bantuan','Produk','Informasi','Keterangan'];
        for (const f of fields) {
          const v = p[f];
          if (v && String(v).toLowerCase().includes(ql)) { matches.push(item); break; }
        }
      });

      if (!matches.length) {
        alert('Tidak ditemukan hasil untuk: ' + q);
        return;
      }

      if (matches.length === 1) {
        const it = matches[0];
        if (it.layer.getLatLng) {
          const pos = it.layer.getLatLng();
          const point = map.project(pos);
          const panel = document.getElementById('infoPanel');
          const panelWidth = (panel && panel.offsetWidth) ? panel.offsetWidth : 340;
          const mapSize = map.getSize();
          point.x = (mapSize.x - panelWidth) / 2;
          const offsetY = 80;
          point.y -= offsetY;
          map.setView(map.unproject(point), Math.max(map.getZoom(), 12));
        } else if (it.layer.getBounds) {
          map.fitBounds(it.layer.getBounds(), { padding: [40,40] });
        }
        if (it.layer.openPopup) it.layer.openPopup();
        showInfoForItem(it);
      } else {
        const latlngs = matches.map(m => (m.layer.getLatLng && m.layer.getLatLng()) || (m.layer.getBounds && m.layer.getBounds().getCenter())).filter(Boolean);
        if (latlngs.length) {
          map.fitBounds(L.latLngBounds(latlngs), { padding: [40,40] });
        }
      }
    }

    const searchBox = document.getElementById('searchBox');
    if (searchBox) {
      const onEnter = (e)=>{ if (e.key === 'Enter') doSearch(); };
      searchBox.addEventListener('keypress', onEnter);
    }

    map.on('popupclose', function(e) {
      try {
        const popup = e.popup || e;
        if (popup && popup._openedByClick) {
          popup._openedByClick = false;
          if (window.initialMapState) {
            map.setView([-2.5489, 118.0149], 5);
          }
          const sb = document.getElementById('searchBox'); if (sb) sb.value = '';
          const y = document.getElementById('filterYear'); if (y) y.value = '';
          const k = document.getElementById('filterKab'); if (k) k.value = '';
          applyFilters();
          clearInfoPanel();
        }
      } catch (err) {}
    });

    const sheetId = '1c8XKStT6LNRws64qjJ6YUbF3aWuXkdUNRNucJzW_V5s';
    const chartSheetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;

    window._doSearch = doSearch;
    window._applyFilters = applyFilters;

    async function fetchChartData() {
      try {
        const response = await fetch(chartSheetUrl);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const csvText = await response.text();
        const lines = csvText.split('\n').map(line => line.trim()).filter(line => line);
        
        const headers = lines[0].split(',').map(h => h.trim().replace(/^"/, '').replace(/"$/, ''));
        const kabupatenIndex = headers.findIndex(h => h === 'Kabupaten/Kota');
        const luasIndex = headers.findIndex(h => h === 'Luas');
        
        if (kabupatenIndex === -1 || luasIndex === -1) {
          throw new Error('Required columns not found in CSV');
        }

        const chartData = [];
        for (let i = 1; i < lines.length; i++) {
          const columns = lines[i].split(',').map(col => col.trim().replace(/^"/, '').replace(/"$/, ''));
          const nama = columns[kabupatenIndex];
          const luasStr = columns[luasIndex];
          const luas = parseFloat(luasStr);
          
          if (nama && !isNaN(luas)) {
            chartData.push({ nama, luas });
          }
        }

        return chartData.sort((a, b) => b.luas - a.luas);
      } catch (error) {
        console.error('Error fetching chart data:', error);
        return [];
      }
    }

    function generateColors(count) {
      const colors = [];
      const baseColors = [
        '#16a34a', '#22c55e', '#10b981', '#059669', '#047857',
        '#0ea5e9', '#0284c7', '#0369a1', '#075985', '#0c4a6e',
        '#8b5cf6', '#7c3aed', '#6d28d9', '#5b21b6', '#4c1d95',
        '#ec4899', '#db2777', '#be185d', '#9f1239', '#881337',
        '#f59e0b', '#d97706', '#b45309', '#92400e', '#78350f'
      ];
      
      for (let i = 0; i < count; i++) {
        const baseColor = baseColors[i % baseColors.length];
        const variation = Math.floor((i / baseColors.length) * 40);
        colors.push(adjustColor(baseColor, variation));
      }
      return colors;
    }

    function adjustColor(color, amount) {
      const num = parseInt(color.slice(1), 16);
      const r = Math.min(255, Math.max(0, (num >> 16) + amount));
      const g = Math.min(255, Math.max(0, ((num >> 8) & 0x00FF) + amount));
      const b = Math.min(255, Math.max(0, (num & 0x0000FF) + amount));
      return '#' + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
    }

    Chart.defaults.font.family = 'Plus Jakarta Sans';
    Chart.defaults.font.size = 13;

    async function updateChart() {
      const chartData = await fetchChartData();
      
      const totalLuas = chartData.reduce((sum, item) => sum + item.luas, 0);
      const jumlahKabupaten = chartData.length;
      const rataRata = (totalLuas / jumlahKabupaten).toFixed(2);
      const terbesar = Math.max(...chartData.map(item => item.luas));

      document.getElementById('totalLuas').textContent = totalLuas.toFixed(2);
      document.getElementById('jumlahKabupaten').textContent = jumlahKabupaten;
      document.getElementById('rataRata').textContent = rataRata;
      document.getElementById('terbesar').textContent = terbesar;

      const legendContainer = document.getElementById('customLegend');
      legendContainer.innerHTML = '';
      const colors = generateColors(chartData.length);
      
      chartData.forEach((item, index) => {
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';
        legendItem.innerHTML = `
          <div class="legend-color" style="background-color: ${colors[index]}"></div>
          <span class="legend-text">${item.nama}</span>
          <span class="legend-value">${item.luas} Ha</span>
        `;
        legendContainer.appendChild(legendItem);
      });

      const ctx = document.getElementById('mangroveChart').getContext('2d');
      if (window.mangroveChart) {
        if (typeof window.mangroveChart.destroy === 'function') {
          window.mangroveChart.destroy();
        } else {
          window.mangroveChart = null;
        }
      }
      window.mangroveChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: chartData.map(item => item.nama),
          datasets: [{
            data: chartData.map(item => item.luas),
            backgroundColor: colors,
            borderColor: '#ffffff',
            borderWidth: 2,
            hoverOffset: 15
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(255, 255, 255, 0.95)',
              titleColor: '#0f172a',
              bodyColor: '#64748b',
              borderColor: '#16a34a',
              borderWidth: 1,
              padding: 12,
              displayColors: true,
              titleFont: {
                size: 14,
                weight: 'bold',
                family: 'Plus Jakarta Sans'
              },
              bodyFont: {
                size: 13,
                family: 'Plus Jakarta Sans'
              },
              callbacks: {
                label: function(context) {
                  const value = context.parsed;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(2);
                  return ` ${value} Ha (${percentage}%)`;
                }
              }
            }
          },
          animation: {
            animateRotate: true,
            animateScale: true,
            duration: 1500,
            easing: 'easeInOutQuart'
          },
          layout: {
            padding: 20
          }
        }
      });
    }

    updateChart();
  </script>

  <script>
    // ============ BURGER MENU ============
    (function() {
      const burger = document.querySelector('.burger-menu');
      const nav = document.querySelector('.nav');
      const links = nav.querySelectorAll('a');
      let isOpen = false;

      function toggle() {
        isOpen = !isOpen;
        burger.setAttribute('aria-expanded', isOpen);
        nav.classList.toggle('active', isOpen);
      }

      burger.addEventListener('click', toggle);

      document.addEventListener('click', (e) => {
        if (isOpen && !nav.contains(e.target) && !burger.contains(e.target)) {
          toggle();
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && isOpen) toggle();
      });

      links.forEach(link => {
        link.addEventListener('click', () => {
          if (isOpen) toggle();
        });
      });

      window.addEventListener('resize', () => {
        if (window.innerWidth > 768 && isOpen) toggle();
      });
    })();
  </script>
</body>
</html>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('/service-worker.js').then(function(reg) {
        console.log('ServiceWorker registered:', reg);
      }).catch(function(err) {
        console.warn('ServiceWorker registration failed:', err);
      });
    });
  }
</script>